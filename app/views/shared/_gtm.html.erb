
<!-- Google Tag Manager - Only loads when consent is given -->
<script>
  // Function to load Google Tag Manager scripts
  function loadGoogleTagManager() {
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({'gtm.start': new Date().getTime(), event: 'gtm.js'});

    const script = document.createElement('script');
    script.async = true;
    script.src = 'https://www.googletagmanager.com/gtm.js?id=GTM-T948MNX';
    document.head.appendChild(script);
  }

  // Check if consent has already been given
  function checkAndLoadGTM() {
    // Check if analytics and marketing cookies are allowed
    const savedPreferences = localStorage.getItem('cookiePreferences');
    if (savedPreferences) {
      try {
        const preferences = JSON.parse(savedPreferences);
        const analyticsAllowed = preferences.analytics === true;
        const marketingAllowed = preferences.marketing === true;

        if (analyticsAllowed && marketingAllowed) {
          loadGoogleTagManager();
        }
      } catch (error) {
        console.error('Error parsing cookie preferences:', error);
      }
    }
  }

  // Listen for consent changes
  window.addEventListener('cookieConsentChanged', function() {
    checkAndLoadGTM();
  });

  // Check on page load
  checkAndLoadGTM();
</script>
